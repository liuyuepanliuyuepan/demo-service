<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.klmb.crm.module.member.dao.instrument.CrmInstrumentMapper">
  <select id="queryBulletin"
    resultType="cn.klmb.crm.module.member.controller.admin.instrument.vo.CrmInstrumentVO">

    SELECT
    a.customerCount,
    b.contactsCount,
    c.activityCount
    FROM
    (
    SELECT
    COUNT(*) AS customerCount
    FROM
    member_user AS c
    WHERE
    DATE_FORMAT(c.create_time,#{time.sqlDateFormat})
    <choose>
      <when test="time.cycleNum==1">
        = #{time.beginTime}
      </when>
      <otherwise>
        BETWEEN #{time.beginTime} and #{time.finalTime}
      </otherwise>
    </choose>
    AND owner_user_id in
    <foreach close=")" collection="userIds" index="i" item="id" open="(" separator=",">
      #{id}
    </foreach>
    AND deleted = false) a,
    (
    SELECT
    COUNT(*) AS contactsCount
    FROM
    member_contacts AS mc
    WHERE
    DATE_FORMAT(mc.create_time,#{time.sqlDateFormat})
    <choose>
      <when test="time.cycleNum==1">
        = #{time.beginTime}
      </when>
      <otherwise>
        BETWEEN #{time.beginTime} and #{time.finalTime}
      </otherwise>
    </choose>
    AND owner_user_id in
    <foreach close=")" collection="userIds" index="i" item="id" open="(" separator=",">
      #{id}
    </foreach>
    AND deleted = false
    ) b,
    (
    SELECT
    COUNT(*) AS activityCount
    FROM
    member_team_activity AS mtc
    WHERE
    DATE_FORMAT(mtc.create_time,#{time.sqlDateFormat})
    <choose>
      <when test="time.cycleNum==1">
        = #{time.beginTime}
      </when>
      <otherwise>
        BETWEEN #{time.beginTime} and #{time.finalTime}
      </otherwise>
    </choose>
    AND creator in
    <foreach close=")" collection="userIds" index="i" item="id" open="(" separator=",">
      #{id}
    </foreach>
    AND deleted = false
    AND type IN ( 1, 4 )
    )c
  </select>
</mapper>
